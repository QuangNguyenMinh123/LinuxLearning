#include "ILI9341.h"
#include "ILI9341_GUI.h"
#include <linux/delay.h>
/*******************************************************************************/

/*******************************************************************************/
uint8_t test_Str[] = {
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x0f, 0xfa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
/*******************************************************************************/
void ILI9341_printImage(ILI9341Type *device, char* ch, int size)
{
	ILI9341_goto(device, 0, 0);
	// ILI9341_Write(device, false, ch, size);
}

void ILI9341_printChar(ILI9341Type *device, char ch)
{
	if (ch == '\n')
	{
		ILI9341_Nextline(device);
	}
	else
	{
		if (device->col + FONT_SIZE < MAX_COL)
		{
			device->col += FONT_SIZE;
		}
		else
		{
			if (device->row + 1 > MAX_ROW)
			{
				ILI9341_goto(device, 0, 0);
			}
			else
			{
				ILI9341_goto(device, 0, device->row + 1);
			}
		}
		// ILI9341_Write(device, false, LCD_Font5x7[(int) ch], FONT_SIZE);
	}
}

void ILI9341_print(ILI9341Type *device, char* ch)
{

}

void ILI9341_WriteReg(ILI9341Type *device, char buff)
{
	gpiod_set_value(device->dcPin, LOW);
	spi_write(device->ili9341, &buff, 1);
}

void ILI9341_WriteData(ILI9341Type *device, char buff)
{
	gpiod_set_value(device->dcPin, HIGH);
	spi_write(device->ili9341, &buff, 1);
}

void ILI9341_CmdMulBytes(ILI9341Type *device, char *buff, int size)
{
	gpiod_set_value(device->dcPin, LOW);
	spi_write(device->ili9341, buff, 1);			/* Send the first byte */
	gpiod_set_value(device->dcPin, HIGH);
	spi_write(device->ili9341, &buff[1], size - 1);	/* Send the rest */
}

void ILI9341_Read(ILI9341Type *device, bool isCommand, char* senBuff, int sendSize, char* saveBuff, int saveSize)
{
	if (isCommand)						/* If command is sent */
		gpiod_set_value(device->dcPin, LOW);
	else								/* If data is sent */
	{
		gpiod_set_value(device->dcPin, HIGH);
	}
	spi_write(device->ili9341, senBuff, sendSize);
	spi_read(device->ili9341, saveBuff, saveSize);
	gpiod_set_value(device->dcPin, LOW);

}

void ILI9341_Reset(ILI9341Type *device)
{
	ILI9341_WriteReg(device, 0x01); 	/* send command 0x01 to reset */
	mdelay(120);
	gpiod_set_value(device->resetPin, LOW);
	mdelay(100);
	gpiod_set_value(device->resetPin, HIGH);
}

void ILI9341_SleepMode(ILI9341Type *device, bool isSleep)
{
	if (isSleep)
	{
		ILI9341_WriteReg(device, 0x10);		/* Command to enter sleep mode */
	}
	else
	{
		ILI9341_WriteReg(device, 0x11);		/* Command to exit sleep mode */
	}
	mdelay(120);
}

void ILI9341_NormalDisplayMode(ILI9341Type *device, bool isNormalMode)
{
	if (isNormalMode)
	{
		ILI9341_WriteReg(device, 0x13);		/* Command to enter sleep mode */
	}
	else
	{
		ILI9341_WriteReg(device, 0x12);		/* Command to exit sleep mode */
	}
	mdelay(120);
}

void ILI9341_InverseMode(ILI9341Type *device, bool isInverse)
{
	if (isInverse)
	{
		ILI9341_WriteReg(device, 0x20);		/* Command to inverse display */
	}
	else
	{
		ILI9341_WriteReg(device, 0x21);		/* Command to not inverse display */
	}
	mdelay(120);
}

void ILI9341_DispalyOn(ILI9341Type *device, bool isON)
{
	if (isON)
	{
		ILI9341_WriteReg(device, 0x29);		/* Command to turn on display */
		
	}
	else
	{
		ILI9341_WriteReg(device, 0x28);		/* Command to turn off display */
		
	}
	mdelay(120);
}

void ILI9341_SetWindow(ILI9341Type *device, int startx, int starty, int sizex, int sizey)
{
	char buffx[5] = {
		0x2A, 					/* Cmd to set Column Address */
		(startx) >> 8,
		startx & 0x00ff,
		(startx + sizex) >> 8,
		(startx + sizex) & 0x00ff
	};
	char buffy[5] = {
		0x2B, 					/* Cmd to set Row Address */
		(starty) >> 8,
		starty & 0x00ff,
		(starty + sizey) >> 8,
		(starty + sizey) & 0x00ff
	};
	ILI9341_CmdMulBytes(device, buffx, 5);
	ILI9341_CmdMulBytes(device, buffy, 5);
}

void ILI9341_goto(ILI9341Type *device, int Col, int Row) 
{
	ILI9341_SetWindow(device, Col, Row, 0, 0);
}

void ILI9341_WriteMem(ILI9341Type *device, char *Userbuff, int size)
{
	int i = 0;
	char buff[4] = {
		0x2C, 			/* Cmd to Write memory */
		0,
		0,
		0
	};
	for (i = 0; i < size; i += 3)
	{
		buff[1] = Userbuff[i];
		buff[2] = Userbuff[i+1];
		buff[3] = Userbuff[i+2];
		ILI9341_CmdMulBytes(device, buff, 4);
	}
}

void ILI9341_Tearing(ILI9341Type *device, bool isTearing)
{
	char buff[2] =
	{
		0x35,			/* Command to turn on tearing */
		0x01
	};
	if (isTearing)		/* Command to turn on tearing */
	{
		ILI9341_CmdMulBytes(device, buff, 2);
	}
	else
	{
		ILI9341_WriteReg(device, 0x34);		/* Command to turn off tearing */
	}
}

void ILI9341_GammaSet(ILI9341Type *device, int value)
{
	char buff[2] =
	{
		0x26,			/* Command to set gamma */
		value & 0b00001111
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_ColorSet(ILI9341Type *device, int red, int green, int blue)
{
	char buff[10] =
	{
		0x2D,			/* Command to set color */
		0b00111111,
		0b00111111,
		0b00111111,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
	};
	ILI9341_CmdMulBytes(device, buff, 10);
}

void ILI9341_Idle(ILI9341Type *device, bool isIdle)
{
	if (isIdle)
	{
		ILI9341_WriteReg(device, 0x39);		/* Command to turn off isIdle */
	}
	else
	{
		ILI9341_WriteReg(device, 0x38);		/* Command to turn off isIdle */
	}
}

void ILI9341_Set18bit(ILI9341Type *device)
{
	char buff[2] =
	{
		0x3A,
		0b01100110
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_SetBrightness(ILI9341Type *device, int value){
	char buff[2] =
	{
		0x51,
		value & 0b11111111
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_SetCTRL(ILI9341Type *device){
	char buff[2] =
	{
		0x53,
		0b00101100
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_SetAdaptiveBrightnessControl(ILI9341Type *device){
	char buff[2] =
	{
		0x55,
		0b11					/* Setting for moving image */
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_SetFrameRate(ILI9341Type *device){
	char buff[2] =
	{
		0xB1,
		0x00,					/* DIVA = fosc */
		0b00011011				/* fps = 70hz */
	};
	ILI9341_CmdMulBytes(device, buff, 2);
}

void ILI9341_Nextline(ILI9341Type *device)
{
	if (device->row + 1 <= MAX_ROW)
		ILI9341_goto(device, 0, device->row + 1);
	else
		ILI9341_goto(device, 0, 0);
}

void ILI9341_ClearScreen(ILI9341Type *device)
{
	ILI9341_goto(device, 0, 0);
}

void ILI9341_PowerInit(ILI9341Type *device)
{
	ILI9341_WriteReg(device, 0xCF);  			// Power control B 
	ILI9341_WriteData(device, 0x00); 
	ILI9341_WriteData(device, 0xD9); //C1 
	ILI9341_WriteData(device, 0X30); 

	ILI9341_WriteReg(device, 0xED);  		// Power on sequence control
	ILI9341_WriteData(device, 0x64); 
	ILI9341_WriteData(device, 0x03); 
	ILI9341_WriteData(device, 0X12); 
	ILI9341_WriteData(device, 0X81);

	ILI9341_WriteReg(device, 0xE8);  		//  Driver timing control A
	ILI9341_WriteData(device, 0x85); 
	ILI9341_WriteData(device, 0x10); 
	ILI9341_WriteData(device, 0x7A); 

	ILI9341_WriteReg(device, 0xCB);  		// Power control A
	ILI9341_WriteData(device, 0x39); 	
	ILI9341_WriteData(device, 0x2C); 
	ILI9341_WriteData(device, 0x00); 
	ILI9341_WriteData(device, 0x34); 
	ILI9341_WriteData(device, 0x02); 

	ILI9341_WriteReg(device, 0xF7);  		// Pump ratio control
	ILI9341_WriteData(device, 0x20);

	ILI9341_WriteReg(device, 0xEA);  		// Driver timing control B
	ILI9341_WriteData(device, 0x00); 
	ILI9341_WriteData(device, 0x00);

	ILI9341_WriteReg(device, 0xC0);    //Power control 
	ILI9341_WriteData(device, 0x1B);   //VRH[5:0] 

	ILI9341_WriteReg(device, 0xC1);    //Power control 
	ILI9341_WriteData(device, 0x12);   //SAP[2:0];BT[3:0] //0x01

	ILI9341_WriteReg(device, 0xC5);    //VCM control 
	ILI9341_WriteData(device, 0x26); 	 //3F
	ILI9341_WriteData(device, 0x26); 	 //3C

	ILI9341_WriteReg(device, 0xC7);    //VCM control2 
	ILI9341_WriteData(device, 0XB0); 

	ILI9341_WriteReg(device, 0x36);    // Memory Access Control 
	ILI9341_WriteData(device, 0x08); 

	ILI9341_WriteReg(device, 0x3A);   // Pixel Format Set : 18 bit or 16 bit
	ILI9341_WriteData(device, 0x55); 

	ILI9341_WriteReg(device, 0xB1);   // Frame Rate Control
	ILI9341_WriteData(device, 0x00);   
	ILI9341_WriteData(device, 0x1A); 

	ILI9341_WriteReg(device, 0xB6);    // Display Function Control 
	ILI9341_WriteData(device, 0x0A); 
	ILI9341_WriteData(device, 0xA2); 
	ILI9341_WriteReg(device, 0xF2);    // 3Gamma Function Disable 
	ILI9341_WriteData(device, 0x00); 

	ILI9341_WriteReg(device, 0x26);    //Gamma curve selected 
	ILI9341_WriteData(device, 0x01); 

	ILI9341_WriteReg(device, 0xE0); //Set Gamma
	ILI9341_WriteData(device, 0x1F);
	ILI9341_WriteData(device, 0x24);
	ILI9341_WriteData(device, 0x24);
	ILI9341_WriteData(device, 0x0D);
	ILI9341_WriteData(device, 0x12);
	ILI9341_WriteData(device, 0x09);
	ILI9341_WriteData(device, 0x52);
	ILI9341_WriteData(device, 0xB7);
	ILI9341_WriteData(device, 0x3F);
	ILI9341_WriteData(device, 0x0C);
	ILI9341_WriteData(device, 0x15);
	ILI9341_WriteData(device, 0x06);
	ILI9341_WriteData(device, 0x0E);
	ILI9341_WriteData(device, 0x08);
	ILI9341_WriteData(device, 0x00);

	ILI9341_WriteReg(device, 0XE1); //Set Gamma
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0x1B);
	ILI9341_WriteData(device, 0x1B);
	ILI9341_WriteData(device, 0x02);
	ILI9341_WriteData(device, 0x0E);
	ILI9341_WriteData(device, 0x06);
	ILI9341_WriteData(device, 0x2E);
	ILI9341_WriteData(device, 0x48);
	ILI9341_WriteData(device, 0x3F);
	ILI9341_WriteData(device, 0x03);
	ILI9341_WriteData(device, 0x0A);
	ILI9341_WriteData(device, 0x09);
	ILI9341_WriteData(device, 0x31);
	ILI9341_WriteData(device, 0x37);
	ILI9341_WriteData(device, 0x1F);

	ILI9341_WriteReg(device, 0x2B); 			// page address
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0x01);
	ILI9341_WriteData(device, 0x3f);

	ILI9341_WriteReg(device, 0x2A); 
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0x00);
	ILI9341_WriteData(device, 0xef);

	ILI9341_WriteReg(device, 0x11); //Exit Sleep
	mdelay(120);
	ILI9341_WriteReg(device, 0x29); //display on	

	ILI9341_WriteReg(device, 0x36);
	ILI9341_WriteData(device, (1<<3)|(0<<6)|(0<<7));
}

void ILI9341_Init(ILI9341Type *device)
{
	ILI9341_Reset(device);
	/* Power setting */
	ILI9341_PowerInit(device);
	/* Display setting */
	// ILI9341_SleepMode(device, false);
	// ILI9341_NormalDisplayMode(device, true);
	// ILI9341_DispalyOn(device, true);
	// ILI9341_InverseMode(device, false);
	// ILI9341_GammaSet(device, 4);
	// ILI9341_Tearing(device, true);
	// ILI9341_Idle(device, false);
	// ILI9341_Set18bit(device);
	// ILI9341_SetBrightness(device, 100);
	// ILI9341_SetCTRL(device);
	// ILI9341_SetAdaptiveBrightnessControl(device);
	// ILI9341_SetFrameRate(device);
	// ILI9341_ColorSet(device, 0, 0, 0);
	// mdelay(200);
	// ILI9341_goto(device, 0 , 0);
	ILI9341_WriteMem(device, test_Str, 500);
}

void ILI9341_Deinit(ILI9341Type *device)
{
	gpiod_put(device->resetPin);
	gpiod_put(device->dcPin);
}
/*******************************************************************************/

/*******************************************************************************/

/*******************************************************************************/

/*******************************************************************************/